# 跨站自动辅种插件

基于"文件名 + 媒体元数据 + 文件大小容差"的跨站匹配算法，实现非 Infohash 依赖的自动化辅种。

## 功能特性

### 核心功能

1. **智能种子扫描**
   - 自动扫描下载器中已完成的种子（做种中/已完成状态）
   - 支持黑名单标签过滤
   - 自动识别种子所属站点并排重

2. **双重元数据提取**
   - 优先使用 MediaChain 通过路径识别媒体信息
   - 兜底使用 MetaInfo 解析种子名称
   - 提取完整元数据：标题、年份、类型、TMDB ID、季集、分辨率等

3. **跨站检索与校验**
   - 基于元数据构建搜索关键词
   - 遍历目标站点进行搜索
   - 文件大小精确校验（默认容差 0.01MB）
   - 随机冷却时间防止封IP（5-10秒）

4. **主辅分离模式**
   - 新站点种子保存路径指向原文件路径
   - 禁用自动种子管理，不允许移动或重命名
   - 自动添加"辅种"标签标识

5. **自动止损机制**
   - 添加种子后立即检测状态
   - 如果状态为"下载中"，判定为辅种失败（非同源）
   - 自动删除种子和源文件，避免浪费空间

6. **智能缓存管理**
   - 成功缓存：记录已辅种成功的种子，避免重复辅种
   - 失败缓存：记录失败原因和重试次数，防止循环重试
   - 支持手动清理缓存

7. **消息通知**
   - 辅种任务完成后发送通知
   - 统计成功/失败数量

## 配置说明

### 基础配置

- **启用插件**: 开启/关闭插件功能
- **发送通知**: 是否发送辅种完成通知
- **立即运行一次**: 立即执行一次辅种任务
- **执行周期**: cron 表达式，如 `0 2 * * *`（每天凌晨2点执行）

### 下载器配置

- **下载器**: 选择要使用的下载器（QB/TR）
- **目标辅种站点**: 选择要辅种到的目标站点（多选）

### 过滤配置

- **排除标签**: 带有这些标签的种子不会被辅种（多个标签用英文逗号分隔）
- **文件大小容差(MB)**: 文件大小匹配的容差范围，默认 0.01MB

### 高级配置

- **主辅分离模式**: 启用后，新站点种子使用原文件路径，不移动文件
- **搜索冷却最小值(秒)**: 站点搜索的最小冷却时间，默认 5 秒
- **搜索冷却最大值(秒)**: 站点搜索的最大冷却时间，默认 10 秒
- **最大重试次数**: 辅种失败后的最大重试次数，默认 3 次
- **清理缓存**: 一键清理所有成功/失败缓存

## 使用流程

### 第一阶段：种子扫描与过滤

1. 扫描下载器中已完成的种子
2. 过滤带有排除标签的种子
3. 跳过已在缓存中的种子（成功/失败）
4. 识别种子所属站点并排重（避免辅种到源站点）

### 第二阶段：元数据提取

1. 通过种子存储路径调用 MediaChain 识别媒体信息
2. 如果识别失败，使用 MetaInfo 解析种子名称（兜底）
3. 提取完整元数据并标准化标题

### 第三阶段：跨站检索与校验

1. 构建搜索关键词（标题 + 年份 + 分辨率 + 季集）
2. 遍历目标站点进行搜索
3. 添加随机冷却时间（5-10秒）
4. 校验文件大小是否在容差范围内

### 第四阶段：推送与主辅分离

1. 根据配置选择推送模式（主辅分离/默认）
2. 添加种子到下载器
3. 立即检测种子状态
4. 如果状态为"下载中"，执行自动止损（删除种子和文件）

### 第五阶段：缓存与通知

1. 更新成功/失败缓存
2. 保存辅种历史记录
3. 发送辅种完成通知

## 注意事项

### 站点流量保护

- 搜索接口必须添加随机冷却时间（5-10秒），防止被封IP
- 失败缓存防止循环重试，节省站点流量
- 建议在低峰时段运行（如凌晨）

### 自动止损机制

- 添加种子后立即检测状态
- 如果状态为"下载中"，立即删除种子和源文件
- 避免非同源种子浪费磁盘空间

### 主辅分离模式

- 新站点种子保存路径指向原文件路径
- 禁用自动种子管理，不允许移动或重命名
- 适合需要保持原文件结构的场景

### 文件大小容差

- 默认 0.01MB（10KB）
- 可根据实际情况调整
- 容差过大可能导致误匹配

### 搜索结果解析

- 当前版本提供搜索框架，实际需要根据站点格式定制
- 不同站点的搜索接口和返回格式差异很大
- 建议为常用站点定制解析逻辑

## 常见问题

### Q: 为什么辅种失败？

A: 可能的原因：
1. 文件大小不匹配（超出容差范围）
2. 站点搜索接口返回格式不支持
3. 种子非同源（自动止损删除）
4. 站点访问失败或被封IP

### Q: 如何避免被站点封IP？

A: 
1. 设置合理的搜索冷却时间（建议 5-10 秒）
2. 在低峰时段运行（如凌晨）
3. 不要频繁运行辅种任务
4. 使用代理（如果站点支持）

### Q: 主辅分离模式和默认模式有什么区别？

A:
- **主辅分离模式**: 新站点种子使用原文件路径，不移动文件，禁用自动种子管理
- **默认模式**: 直接添加到源种子默认路径，允许下载器自动管理

### Q: 如何清理缓存？

A: 在插件配置页面开启"清理缓存"开关，保存配置即可清理所有缓存。

### Q: 为什么有些种子没有被辅种？

A: 可能的原因：
1. 种子带有排除标签
2. 种子已在成功缓存中
3. 种子已达到最大重试次数
4. 无法提取元数据
5. 跨站检索无匹配结果

## 开发信息

- **插件版本**: 1.0
- **插件作者**: zhjay
- **作者主页**: https://github.com/Jie795
- **适用版本**: MoviePilot V2

## 更新日志

### v1.0 (2026-02-15)

- 首个版本发布
- 实现基于元数据的跨站辅种
- 支持主辅分离模式
- 支持自动止损机制
- 支持智能缓存管理
- 支持消息通知

## 技术支持

如有问题或建议，请联系插件作者或在 GitHub 提交 Issue。
